// =====================================================
// GOOGLE APPS SCRIPT - BLOCKCHAIN MAHASISWA
// =====================================================
// Copy paste kode ini ke Google Apps Script Editor
// =====================================================

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

    if (!e || !e.postData || !e.postData.contents) {
      return ContentService.createTextOutput(JSON.stringify({
        status: "error",
        message: "No data received"
      })).setMimeType(ContentService.MimeType.JSON);
    }

    const data = JSON.parse(e.postData.contents);

    const allData = sheet.getDataRange().getValues();

    if (allData.length === 0 || allData[0].length === 0 || allData[0][0] === "") {
      sheet.appendRow([
        "block_id",
        "student_id",
        "nama_mahasiswa",
        "mata_kuliah_id",
        "mata_kuliah",
        "jenis_mata_kuliah",
        "nilai",
        "semester",
        "tanggal",
        "dosen_id",
        "dosen_pengampu",
        "current_hash"
      ]);
    }

    const currentData = sheet.getDataRange().getValues();

    if (currentData.length > 1) {
      for (let i = 1; i < currentData.length; i++) {
        const row = currentData[i];
        const existingStudentId = row[1];
        const existingMataKuliahId = row[3];
        const existingJenisMataKuliah = row[5];
        const existingSemester = row[7];

        if (existingStudentId == data.student_id &&
            existingMataKuliahId == data.mata_kuliah_id &&
            existingJenisMataKuliah == data.jenis_mata_kuliah &&
            existingSemester == data.semester) {
          return ContentService.createTextOutput(JSON.stringify({
            status: "duplicate",
            message: "Data already exists in Google Sheets"
          })).setMimeType(ContentService.MimeType.JSON);
        }
      }
    }

    sheet.appendRow([
      data.block_id,
      data.student_id,
      data.nama_mahasiswa,
      data.mata_kuliah_id,
      data.mata_kuliah,
      data.jenis_mata_kuliah,
      data.nilai,
      data.semester,
      data.tanggal,
      data.dosen_id,
      data.dosen_pengampu,
      data.current_hash
    ]);

    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      message: "Data saved to Google Sheets"
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();

    if (data.length === 0) {
      return ContentService.createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }

    const headers = data[0];
    const rows = data.slice(1);

    const result = rows.map(row => {
      const obj = {};
      headers.forEach((header, index) => {
        obj[header] = row[index];
      });
      return obj;
    });

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
